window.DIPF_PISA_WRAPPER=new class{constructor(){this.allStates={};this.units=BW__ITEMDATA();this.dtObjId=0;this.fsm=new fsmSend;this.currentItemIdx=0;this.currentUnitIdx=0;window.getState=this.getState.bind(this);window.setState=this.setState.bind(this);this.loadUnit0Timer=setTimeout(this.loadUnit0.bind(this),200)}loadUnit0(){this.loadUnit0Timer=null;this.loadPage(0,0)}loadPage(unitIdx,itemIdx,saveCurrent=true){if(saveCurrent){this.saveStateToAllStates()}const unit=this.units[unitIdx];this.currentUnitIdx=unitIdx;this.allStates.unit=unit.name;const item=unit.items[itemIdx];this.currentItemIdx=itemIdx;this.allStates.item=item.itemName;if(saveCurrent){this.fsm.triggerEvent("triggerSnapshot")}const setAttr=(id,attr,val)=>{const el=document.getElementById(id);if(el){el[attr]=val}};setAttr("platformCss","href","unit/"+unit.subdir+"/"+unit.name+"/"+item.css);setAttr("platformLocaleCss","href","unit/"+unit.subdir+"/"+unit.name+"/deu-DEU/"+item.css);setAttr("stimulus","src","unit/"+unit.subdir+"/"+unit.name+"/deu-DEU/"+item.stim);setAttr("question","src","unit/"+unit.subdir+"/"+unit.name+"/deu-DEU/"+item.quest);this.setNavPrev();this.sendEvent("PAGE_LOAD")}navPrev(){let unitIdx=this.currentUnitIdx;let itemIdx=this.currentItemIdx;const navWin=this.getNavigation();if(!navWin){return}const navPrev=navWin.document.getElementById("previous");if(navPrev&&navPrev.getAttribute("disabled")){return}if(itemIdx>0){itemIdx--}else if(unitIdx>0){unitIdx--;itemIdx=this.units[unitIdx].items.length-1}this.loadPage(unitIdx,itemIdx)}navNext(endItemAck=false){if(!endItemAck){this.sendEvent("NAV_NEXT")}if(this.units[this.currentUnitIdx].items[this.currentItemIdx].warning=="endItem"&&!endItemAck){this.showEndItemWarning();return}let unitIdx=this.currentUnitIdx;let unit=this.units[unitIdx];let itemIdx=this.currentItemIdx+1;if(itemIdx>=unit.items.length){if(!endItemAck){this.showEndItemWarning();return}unitIdx++;if(unitIdx>=this.units.length){this.fsm.triggerEvent("EV_NextTask");return}itemIdx=0}this.loadPage(unitIdx,itemIdx)}getCurrentItemNos(){const unit=this.units[this.currentUnitIdx];return unit.items.length>1?[this.currentItemIdx,unit.items.length-1]:[1,1]}getAllStates(){return this.allStates}getNavigation(){const nav=document.getElementById("navigation");return nav?nav.contentWindow:undefined}setNavPrev(){const enable=this.currentItemIdx>0&&this.units[this.currentUnitIdx].items[this.currentItemIdx].navigation!=="noback";console.log("---",enable);const navWin=this.getNavigation();if(navWin){const navPrev=navWin.document.getElementById("previous");if(navPrev){if(enable){navPrev.removeAttribute("disabled")}else{navPrev.setAttribute("disabled","disabled")}}}}createIFrame(id,src){const iframe=document.createElement("IFRAME");iframe.src=src;iframe.id=id;const container=document.getElementById("naxContainer");if(container){container.appendChild(iframe)}}showEndItemWarning(){this.sendEvent("WARN_SHOW");this.hideEndItemWarning(false);this.createIFrame("dialog","module/dialog/eng-ZZZ/index.html")}hideEndItemWarning(){const iframe=document.getElementById("dialog");if(iframe){iframe.remove()}}endItemWarningYesClicked(){this.sendEvent("WARN_CLICK_YES");this.hideEndItemWarning();this.navNext(true)}endItemWarningNoClicked(){this.sendEvent("WARN_CLICK_NO");this.hideEndItemWarning()}showHelp(){this.sendEvent("HELP_SHOW");this.hideHelp(false);this.createIFrame("help","module/help/deu-DEU/index.html")}hideHelp(log=true){if(log){this.sendEvent("HELP_CLOSE")}const iframe=document.getElementById("help");if(iframe){iframe.remove()}}timeWarningOpened(){this.sendEvent("TIME_SHOW")}timeWarningClosed(){this.sendEvent("TIME_CLOSE")}saveStateToAllStates(){const stim=document.getElementById("stimulus");const stimState=stim&&stim.contentWindow.getState?stim.contentWindow.getState(this.allStates.item):{};const quest=document.getElementById("question");const questState=quest&&quest.contentWindow.getState?quest.contentWindow.getState(this.allStates.item):{};Object.assign(this.allStates,stimState,questState)}getState(saveCurrentState=false){this.saveStateToAllStates();return this.allStates}setState(state){if(this.loadUnit0Timer){clearTimeout(this.loadUnit0Timer);this.loadUnit0Timer=null}const unitIdx=state.unit?this.units.findIndex(unit=>unit.name==state.unit):0;if(unitIdx==-1){return}const itemIdx=state.item?this.units[unitIdx].items.findIndex(item=>item.itemName==state.item):0;if(itemIdx==-1){return}this.allStates=state;this.loadPage(unitIdx,itemIdx,false)}dtGetNextObjId(){if(!("objIds"in this.allStates)){this.allStates.objIds={}}if(!(this.allStates.item in this.allStates.objIds)){this.allStates.objIds[this.allStates.item]=0}return++this.allStates.objIds[this.allStates.item]}addCommonLogData(evData,obj){const scaleX=obj.get("scaleX");const scaleY=obj.get("scaleY");if(scaleX&&scaleX!=1||scaleY&&scaleY!=1){evData.scaleX=scaleX;evData.scaleY=scaleY}const angle=obj.get("angle");if(angle){evData.angle=angle}}getObjDiffs(obj){const res={};[["top","left"],["width","height"],["scaleX","scaleY"]].forEach(ar=>{const v=ar.map(a=>obj[a]);const o_v=ar.map(a=>obj.originalState[a]);if(v[0]!==o_v[0]||v[1]!==o_v[1]){ar.forEach((a,i)=>{res[a]=v[i];res["o_"+a]=o_v[i];res["d_"+a]=v[i]-o_v[i]})}});const angle=obj.angle,o_angle=obj.originalState.angle;if(angle!==o_angle){res.angle=angle;res.o_angle=o_angle;res.d_angle=angle-o_angle}return res}sendEvent(eventData,additional){if(typeof eventData==="string"){eventData={event:eventData}}if(this.allStates.item){eventData.item=this.allStates.item}if(additional){Object.assign(eventData,additional)}for(const k in eventData){const r=1e4;if(typeof eventData[k]==="number"||typeof eventData[k]==="string"&&eventData[k].match(/^[0-9]+\.[0-9]+$/)){eventData[k]=Math.round(eventData[k]*r)/r}}this.fsm.postLogEvent(eventData)}};
